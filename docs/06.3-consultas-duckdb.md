# 06.3 - Consultas DuckDB (Etapa 3.1)

Guia prático para executar consultas SQL na camada canônica `data/processed/**/*.parquet` usando a função `query(sql)` em `src/rag/executor.py`.

## 1. Pré-requisitos

- Pipeline de dados concluído (`data/processed` preenchido).
- Dependências instaladas (`duckdb`, `pandas`, `pyarrow`).

## 2. Passo a passo da consulta

1. Importar a função:
   ```python
   from src.rag.executor import query
   ```
2. Escrever SQL sobre a view `processed`:
   ```sql
   SELECT COUNT(*) AS total_linhas
   FROM processed
   ```
3. Executar:
   ```python
   df = query("SELECT COUNT(*) AS total_linhas FROM processed")
   ```
4. Ler o resultado no DataFrame (`df`).

Observação: a função cria uma conexão DuckDB em memória (`:memory:`) e uma view temporária `processed` apontando para `data/processed/**/*.parquet`.

## 3. Exemplos de consulta

### 3.1 Volume total da base

```sql
SELECT COUNT(*) AS total_linhas
FROM processed;
```

### 3.2 Linhas por sistema (SIA x SIH)

```sql
SELECT sistema, COUNT(*) AS linhas
FROM processed
GROUP BY sistema
ORDER BY linhas DESC;
```

### 3.3 Série mensal de custo (`ano_mes`)

```sql
SELECT ano_mes, SUM(custo_total) AS custo_total_mes
FROM processed
GROUP BY ano_mes
ORDER BY ano_mes;
```

### 3.4 Top 10 UFs por custo total

```sql
SELECT uf_origem, SUM(custo_total) AS custo_total
FROM processed
GROUP BY uf_origem
ORDER BY custo_total DESC
LIMIT 10;
```

### 3.5 Custo médio por faixa etária

```sql
SELECT idade_grupo, AVG(custo_total) AS custo_medio
FROM processed
GROUP BY idade_grupo
ORDER BY idade_grupo;
```

### 3.6 Monitoramento de nulos em colunas-chave

```sql
SELECT
  SUM(CASE WHEN main_icd IS NULL OR TRIM(main_icd) = '' THEN 1 ELSE 0 END) AS nulos_main_icd,
  SUM(CASE WHEN custo_total IS NULL THEN 1 ELSE 0 END) AS nulos_custo_total,
  SUM(CASE WHEN ano_mes IS NULL THEN 1 ELSE 0 END) AS nulos_ano_mes
FROM processed;
```

## 4. Exemplo completo em Python

```python
from src.rag.executor import query


def main() -> None:
    sql = """
    SELECT sistema, COUNT(*) AS linhas, ROUND(AVG(custo_total), 2) AS custo_medio
    FROM processed
    GROUP BY sistema
    ORDER BY linhas DESC
    """
    df = query(sql)
    print(df)


if __name__ == "__main__":
    main()
```

Arquivo pronto para teste local: `notebooks/etapa3_duckdb_query_example.py`.

## 5. Regras para escrever SQL

- Sempre consultar a view `processed`.
- Evitar `SELECT *` em consultas analíticas grandes; preferir colunas explícitas.
- Usar filtros de período com `ano_mes`, `ano_cmpt` e `mes_cmpt` quando possível.
- Garantir agregações auditáveis (`COUNT`, `SUM`, `AVG`, `MIN`, `MAX`).

[← Voltar ao índice](README.md)
